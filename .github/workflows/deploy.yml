# =============================================================================
# DMAIIN Phase 1 - CI/CD Pipeline
# =============================================================================
#
# Triggers:
#   - Push to main branch
#   - Pull request targeting main branch
#
# Jobs:
#   1. lint-and-test: Run Lambda unit tests and build frontend
#   2. deploy: Deploy infrastructure and frontend (only on push to main)
#
# Required GitHub Secrets:
#   - AWS_ACCESS_KEY_ID
#   - AWS_SECRET_ACCESS_KEY
#   - AWS_REGION (optional, defaults to us-east-1)
# =============================================================================

name: DMAIIN CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  TERRAFORM_VERSION: "1.7.0"

jobs:
  # ===========================================================================
  # Job 1: Lint, Unit Tests, and Frontend Build
  # ===========================================================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Python setup and Lambda unit tests
      # -----------------------------------------------------------------------
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install Python test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest moto boto3 botocore

      - name: Install Lambda dependencies
        run: |
          for req in lambda/*/requirements.txt; do
            echo "Installing dependencies from ${req}..."
            pip install -r "$req"
          done

      - name: Run Lambda unit tests
        run: |
          # Add each Lambda directory to the Python path for imports
          export PYTHONPATH="${PYTHONPATH:+${PYTHONPATH}:}"
          for lambda_dir in lambda/*/; do
            if [ -d "${lambda_dir}tests" ]; then
              echo "=========================================="
              echo "Testing: ${lambda_dir}"
              echo "=========================================="
              PYTHONPATH="${lambda_dir}:${PYTHONPATH}" pytest "${lambda_dir}tests/" -v --tb=short
            fi
          done

      # -----------------------------------------------------------------------
      # Node.js setup and frontend build
      # -----------------------------------------------------------------------
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          CI: true

  # ===========================================================================
  # Job 2: Deploy (only on push to main)
  # ===========================================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    environment: production

    permissions:
      contents: read
      id-token: write

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # AWS credentials
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------------------------------------------------
      # Python setup (for Lambda packaging)
      # -----------------------------------------------------------------------
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # -----------------------------------------------------------------------
      # Package Lambda functions
      # -----------------------------------------------------------------------
      - name: Package Lambda functions
        run: |
          for lambda_dir in lambda/*/; do
            lambda_name="$(basename "$lambda_dir")"
            echo "Packaging: ${lambda_name}"

            if [ ! -f "${lambda_dir}lambda_function.py" ]; then
              echo "  Skipping (no lambda_function.py)"
              continue
            fi

            if [ -f "${lambda_dir}requirements.txt" ]; then
              pip install -q -r "${lambda_dir}requirements.txt" -t "${lambda_dir}package/"
            else
              mkdir -p "${lambda_dir}package/"
            fi

            cp "${lambda_dir}lambda_function.py" "${lambda_dir}package/"

            (cd "${lambda_dir}package" && zip -r -q "../package.zip" .)
            rm -rf "${lambda_dir}package/"

            echo "  Created: ${lambda_dir}package.zip"
          done

      # -----------------------------------------------------------------------
      # Terraform setup and deploy
      # -----------------------------------------------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      # -----------------------------------------------------------------------
      # Get Terraform outputs (needed for frontend build)
      # -----------------------------------------------------------------------
      - name: Get Terraform outputs
        id: terraform-outputs
        working-directory: terraform
        run: |
          echo "frontend_bucket=$(terraform output -raw frontend_bucket_name)" >> "$GITHUB_OUTPUT"
          echo "api_url=$(terraform output -raw api_gateway_url)" >> "$GITHUB_OUTPUT"
          echo "frontend_url=$(terraform output -raw frontend_url)" >> "$GITHUB_OUTPUT"
          echo "cognito_user_pool_id=$(terraform output -raw cognito_user_pool_id)" >> "$GITHUB_OUTPUT"
          echo "cognito_client_id=$(terraform output -raw cognito_user_pool_client_id)" >> "$GITHUB_OUTPUT"
          echo "region=$(terraform output -raw aws_region)" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------------------
      # Build and deploy frontend to S3
      # -----------------------------------------------------------------------
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          CI: true
          REACT_APP_API_URL: ${{ steps.terraform-outputs.outputs.api_url }}
          REACT_APP_COGNITO_USER_POOL_ID: ${{ steps.terraform-outputs.outputs.cognito_user_pool_id }}
          REACT_APP_COGNITO_CLIENT_ID: ${{ steps.terraform-outputs.outputs.cognito_client_id }}
          REACT_APP_AWS_REGION: ${{ steps.terraform-outputs.outputs.region }}

      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/build/ "s3://${{ steps.terraform-outputs.outputs.frontend_bucket }}/" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "service-worker.js"

          # Upload index.html and service-worker.js with no-cache
          aws s3 cp frontend/build/index.html \
            "s3://${{ steps.terraform-outputs.outputs.frontend_bucket }}/index.html" \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Deployment summary
        run: |
          echo "=========================================="
          echo "DMAIIN Phase 1 Deployment Complete"
          echo "=========================================="
          echo "Frontend URL: ${{ steps.terraform-outputs.outputs.frontend_url }}"
          echo "API URL:      ${{ steps.terraform-outputs.outputs.api_url }}"
          echo "=========================================="
